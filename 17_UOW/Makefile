# ==============================================================================
# VariÃ¡veis
# ==============================================================================
APP_NAME=uow-demo
VERSION?=latest
PORT?=3306
DB_HOST?=localhost
DB_PORT?=3306
DB_USER?=root
DB_PASS?=root
DB_NAME?=courses

# Cores
BLUE=\033[0;34m
GREEN=\033[0;32m
RED=\033[0;31m
YELLOW=\033[0;33m
NC=\033[0m

# ==============================================================================
# Comandos de Desenvolvimento
# ==============================================================================
.PHONY: setup run test lint docs clean

setup: ## Configura o ambiente
	@echo "$(BLUE)ğŸ”§ Configurando ambiente...$(NC)"
	@go mod download
	@go install github.com/kyleconroy/sqlc/cmd/sqlc@latest

run: ## Roda a aplicaÃ§Ã£o
	@echo "$(BLUE)ğŸš€ Iniciando aplicaÃ§Ã£o...$(NC)"
	@go run cmd/main.go

test: ## Roda os testes
	@echo "$(BLUE)ğŸ§ª Executando testes...$(NC)"
	@go test -v ./...

test-uow: ## Roda apenas os testes de UOW
	@echo "$(BLUE)ğŸ§ª Executando testes de UOW...$(NC)"
	@go test -v -run TestAddCourseUow ./internal/usecase/

test-without-uow: ## Roda apenas os testes sem UOW
	@echo "$(BLUE)ğŸ§ª Executando testes sem UOW...$(NC)"
	@go test -v -run TestAddCourse ./internal/usecase/

lint: ## Executa o linter
	@echo "$(BLUE)ğŸ” Verificando cÃ³digo...$(NC)"
	@golangci-lint run

docs: ## Gera documentaÃ§Ã£o SQLC
	@echo "$(BLUE)ğŸ“š Gerando cÃ³digo SQLC...$(NC)"
	@sqlc generate

# ==============================================================================
# Comandos de Banco de Dados
# ==============================================================================
db-up: ## Sobe o banco de dados
	@echo "$(BLUE)ğŸ³ Subindo MySQL...$(NC)"
	@docker-compose up -d

db-down: ## Para o banco de dados
	@echo "$(BLUE)ğŸ³ Parando MySQL...$(NC)"
	@docker-compose down

db-reset: ## Reseta o banco de dados
	@echo "$(BLUE)ğŸ”„ Resetando banco de dados...$(NC)"
	@docker-compose down -v
	@docker-compose up -d
	@sleep 5
	@make db-migrate

db-migrate: ## Executa as migraÃ§Ãµes
	@echo "$(BLUE)ğŸ“Š Executando migraÃ§Ãµes...$(NC)"
	@docker exec -i mysql mysql -u $(DB_USER) -p$(DB_PASS) $(DB_NAME) < sql/schema.sql

db-shell: ## Acessa o shell do MySQL
	@echo "$(BLUE)ğŸš Acessando shell do MySQL...$(NC)"
	@docker exec -it mysql mysql -u $(DB_USER) -p$(DB_PASS) $(DB_NAME)

# ==============================================================================
# Comandos Docker
# ==============================================================================
docker-build: ## Build da imagem Docker
	@echo "$(BLUE)ğŸ³ Construindo imagem Docker...$(NC)"
	@docker build -t $(APP_NAME):$(VERSION) .

docker-run: ## Roda o container
	@echo "$(BLUE)ğŸ³ Iniciando container...$(NC)"
	@docker run -p $(PORT):$(PORT) $(APP_NAME):$(VERSION)

# ==============================================================================
# Comandos de Limpeza
# ==============================================================================
clean: ## Limpa arquivos temporÃ¡rios
	@echo "$(BLUE)ğŸ§¹ Limpando arquivos temporÃ¡rios...$(NC)"
	@go clean
	@rm -f server

clean-db: ## Limpa dados do banco
	@echo "$(BLUE)ğŸ§¹ Limpando dados do banco...$(NC)"
	@docker-compose down -v

# ==============================================================================
# Comandos de Desenvolvimento Completo
# ==============================================================================
dev-setup: setup db-up ## ConfiguraÃ§Ã£o completa para desenvolvimento
	@echo "$(GREEN)âœ… Ambiente de desenvolvimento configurado!$(NC)"
	@echo "$(YELLOW)ğŸ’¡ Execute 'make test' para testar$(NC)"

dev-test: db-up test ## Executa testes com banco configurado
	@echo "$(GREEN)âœ… Testes executados!$(NC)"

# ==============================================================================
# Ajuda
# ==============================================================================
help: ## Mostra essa ajuda
	@echo "$(BLUE)Comandos disponÃ­veis:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'

.DEFAULT_GOAL := help
