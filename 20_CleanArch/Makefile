# ==============================================================================
# VariÃ¡veis
# ==============================================================================
APP_NAME=ordersystem
VERSION?=latest
GO_VERSION=1.24

# Portas
WEB_PORT?=8080
GRPC_PORT?=50051
GRAPHQL_PORT?=8082

# Database
DB_HOST?=localhost
DB_PORT?=3306
DB_USER?=root
DB_PASSWORD?=root
DB_NAME?=orders

# Cores para output
BLUE=\033[0;34m
GREEN=\033[0;32m
RED=\033[0;31m
YELLOW=\033[0;33m
NC=\033[0m

# ==============================================================================
# Comandos de Setup
# ==============================================================================
.PHONY: setup
setup: ## Configura o ambiente de desenvolvimento
	@echo "$(BLUE)ğŸ”§ Configurando ambiente...$(NC)"
	@go mod download
	@echo "$(GREEN)âœ“ DependÃªncias baixadas$(NC)"
	@go install github.com/99designs/gqlgen@latest
	@echo "$(GREEN)âœ“ gqlgen instalado$(NC)"
	@go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
	@go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
	@echo "$(GREEN)âœ“ protoc plugins instalados$(NC)"
	@go install github.com/google/wire/cmd/wire@latest
	@echo "$(GREEN)âœ“ wire instalado$(NC)"
	@if [ ! -f .env ]; then cp env.example .env; echo "$(GREEN)âœ“ Arquivo .env criado$(NC)"; fi
	@echo "$(GREEN)âœ… Setup concluÃ­do!$(NC)"

.PHONY: setup-tools
setup-tools: ## Instala ferramentas adicionais de desenvolvimento
	@echo "$(BLUE)ğŸ”§ Instalando ferramentas...$(NC)"
	@go install golang.org/x/tools/cmd/goimports@latest
	@go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	@go install github.com/fullstorydev/grpcurl/cmd/grpcurl@latest
	@echo "$(GREEN)âœ… Ferramentas instaladas!$(NC)"

# ==============================================================================
# Comandos de Desenvolvimento
# ==============================================================================
.PHONY: run
run: ## Executa a aplicaÃ§Ã£o
	@echo "$(BLUE)ğŸš€ Iniciando aplicaÃ§Ã£o...$(NC)"
	@echo "$(YELLOW)Web Server: http://localhost:$(WEB_PORT)$(NC)"
	@echo "$(YELLOW)gRPC Server: localhost:$(GRPC_PORT)$(NC)"
	@echo "$(YELLOW)GraphQL Playground: http://localhost:$(GRAPHQL_PORT)$(NC)"
	@go run ./cmd/ordersystem

.PHONY: run-dev
run-dev: docker-up ## Sobe infraestrutura e executa a aplicaÃ§Ã£o
	@sleep 3
	@$(MAKE) run

.PHONY: build
build: ## Compila o binÃ¡rio da aplicaÃ§Ã£o
	@echo "$(BLUE)ğŸ”¨ Compilando aplicaÃ§Ã£o...$(NC)"
	@go build -o $(APP_NAME) ./cmd/ordersystem
	@echo "$(GREEN)âœ… BinÃ¡rio criado: ./$(APP_NAME)$(NC)"

.PHONY: build-linux
build-linux: ## Compila para Linux
	@echo "$(BLUE)ğŸ”¨ Compilando para Linux...$(NC)"
	@GOOS=linux GOARCH=amd64 go build -o $(APP_NAME)-linux ./cmd/ordersystem
	@echo "$(GREEN)âœ… BinÃ¡rio criado: ./$(APP_NAME)-linux$(NC)"

# ==============================================================================
# Comandos de Testes
# ==============================================================================
.PHONY: test
test: ## Executa todos os testes
	@echo "$(BLUE)ğŸ§ª Executando testes...$(NC)"
	@go test ./... -v

.PHONY: test-short
test-short: ## Executa testes rÃ¡pidos
	@echo "$(BLUE)ğŸ§ª Executando testes rÃ¡pidos...$(NC)"
	@go test ./... -short

.PHONY: test-coverage
test-coverage: ## Executa testes com cobertura
	@echo "$(BLUE)ğŸ§ª Executando testes com cobertura...$(NC)"
	@go test ./... -coverprofile=coverage.out
	@go tool cover -html=coverage.out -o coverage.html
	@echo "$(GREEN)âœ… RelatÃ³rio gerado: coverage.html$(NC)"

.PHONY: test-race
test-race: ## Executa testes com detector de race conditions
	@echo "$(BLUE)ğŸ§ª Executando testes com race detector...$(NC)"
	@go test ./... -race

.PHONY: test-entity
test-entity: ## Executa testes da camada de entidade
	@echo "$(BLUE)ğŸ§ª Testando entidades...$(NC)"
	@go test ./internal/entity -v

.PHONY: test-usecase
test-usecase: ## Executa testes dos use cases
	@echo "$(BLUE)ğŸ§ª Testando use cases...$(NC)"
	@go test ./internal/usecase -v

.PHONY: test-web
test-web: ## Executa testes da camada web
	@echo "$(BLUE)ğŸ§ª Testando web handlers...$(NC)"
	@go test ./internal/infra/web -v

.PHONY: test-database
test-database: ## Executa testes do repositÃ³rio
	@echo "$(BLUE)ğŸ§ª Testando database...$(NC)"
	@go test ./internal/infra/database -v

.PHONY: test-events
test-events: ## Executa testes de eventos
	@echo "$(BLUE)ğŸ§ª Testando eventos...$(NC)"
	@go test ./events -v

# ==============================================================================
# Comandos de Qualidade de CÃ³digo
# ==============================================================================
.PHONY: lint
lint: ## Executa o linter
	@echo "$(BLUE)ğŸ” Verificando cÃ³digo...$(NC)"
	@golangci-lint run ./... || echo "$(YELLOW)âš ï¸  Instale golangci-lint: make setup-tools$(NC)"

.PHONY: fmt
fmt: ## Formata o cÃ³digo
	@echo "$(BLUE)âœ¨ Formatando cÃ³digo...$(NC)"
	@go fmt ./...
	@goimports -w . || echo "$(YELLOW)âš ï¸  Instale goimports: make setup-tools$(NC)"
	@echo "$(GREEN)âœ… CÃ³digo formatado!$(NC)"

.PHONY: vet
vet: ## Executa go vet
	@echo "$(BLUE)ğŸ” Executando go vet...$(NC)"
	@go vet ./...

.PHONY: check
check: fmt vet lint test ## Executa todas as verificaÃ§Ãµes

# ==============================================================================
# Comandos Docker
# ==============================================================================
.PHONY: docker-up
docker-up: ## Sobe os containers (MySQL e RabbitMQ)
	@echo "$(BLUE)ğŸ³ Subindo containers...$(NC)"
	@docker-compose up -d
	@echo "$(GREEN)âœ… Containers iniciados!$(NC)"
	@echo "$(YELLOW)MySQL: localhost:3306$(NC)"
	@echo "$(YELLOW)RabbitMQ: localhost:5672$(NC)"
	@echo "$(YELLOW)RabbitMQ Management: http://localhost:15672 (guest/guest)$(NC)"

.PHONY: docker-down
docker-down: ## Para os containers
	@echo "$(BLUE)ğŸ³ Parando containers...$(NC)"
	@docker-compose down
	@echo "$(GREEN)âœ… Containers parados!$(NC)"

.PHONY: docker-logs
docker-logs: ## Mostra logs dos containers
	@docker-compose logs -f

.PHONY: docker-clean
docker-clean: ## Remove containers e volumes
	@echo "$(BLUE)ğŸ³ Limpando containers e volumes...$(NC)"
	@docker-compose down -v
	@echo "$(GREEN)âœ… Limpeza concluÃ­da!$(NC)"

.PHONY: docker-restart
docker-restart: docker-down docker-up ## Reinicia os containers

# ==============================================================================
# Comandos de GeraÃ§Ã£o de CÃ³digo
# ==============================================================================
.PHONY: proto
proto: ## Gera cÃ³digo a partir dos arquivos .proto
	@echo "$(BLUE)ğŸ“ Gerando cÃ³digo protobuf...$(NC)"
	@protoc --go_out=. --go-grpc_out=. internal/infra/grpc/protofiles/order.proto
	@echo "$(GREEN)âœ… CÃ³digo protobuf gerado!$(NC)"

.PHONY: graphql
graphql: ## Gera cÃ³digo GraphQL
	@echo "$(BLUE)ğŸ“ Gerando cÃ³digo GraphQL...$(NC)"
	@go run github.com/99designs/gqlgen generate
	@echo "$(GREEN)âœ… CÃ³digo GraphQL gerado!$(NC)"

.PHONY: wire
wire: ## Gera cÃ³digo de injeÃ§Ã£o de dependÃªncias
	@echo "$(BLUE)ğŸ“ Gerando cÃ³digo Wire...$(NC)"
	@cd cmd/ordersystem && wire
	@echo "$(GREEN)âœ… CÃ³digo Wire gerado!$(NC)"

.PHONY: generate
generate: proto graphql wire ## Gera todo o cÃ³digo (proto, graphql, wire)
	@echo "$(GREEN)âœ… Todo cÃ³digo gerado com sucesso!$(NC)"

# ==============================================================================
# Comandos de Database
# ==============================================================================
.PHONY: db-create
db-create: ## Cria o banco de dados
	@echo "$(BLUE)ğŸ’¾ Criando banco de dados...$(NC)"
	@docker exec -it mysql mysql -u$(DB_USER) -p$(DB_PASSWORD) -e "CREATE DATABASE IF NOT EXISTS $(DB_NAME);"
	@echo "$(GREEN)âœ… Banco criado!$(NC)"

.PHONY: db-migrate
db-migrate: ## Executa as migrations
	@echo "$(BLUE)ğŸ’¾ Executando migrations...$(NC)"
	@docker exec -it mysql mysql -u$(DB_USER) -p$(DB_PASSWORD) $(DB_NAME) -e "\
		CREATE TABLE IF NOT EXISTS orders (\
			id varchar(255) NOT NULL,\
			price float NOT NULL,\
			tax float NOT NULL,\
			final_price float NOT NULL,\
			PRIMARY KEY (id)\
		);"
	@echo "$(GREEN)âœ… Migrations executadas!$(NC)"

.PHONY: db-drop
db-drop: ## Remove o banco de dados
	@echo "$(RED)âš ï¸  Removendo banco de dados...$(NC)"
	@docker exec -it mysql mysql -u$(DB_USER) -p$(DB_PASSWORD) -e "DROP DATABASE IF EXISTS $(DB_NAME);"
	@echo "$(GREEN)âœ… Banco removido!$(NC)"

.PHONY: db-reset
db-reset: db-drop db-create db-migrate ## Reseta o banco de dados

# ==============================================================================
# Comandos de Teste Manual
# ==============================================================================
.PHONY: test-http
test-http: ## Testa endpoint HTTP (requer httpie ou curl)
	@echo "$(BLUE)ğŸ§ª Testando endpoint HTTP...$(NC)"
	@curl -X POST http://localhost:$(WEB_PORT)/order \
		-H "Content-Type: application/json" \
		-d '{"id":"test-'$$(date +%s)'","price":100.0,"tax":10.0}' || \
		echo "$(RED)âŒ Erro: Certifique-se que a aplicaÃ§Ã£o estÃ¡ rodando$(NC)"

.PHONY: test-grpc
test-grpc: ## Testa endpoint gRPC (requer grpcurl)
	@echo "$(BLUE)ğŸ§ª Testando endpoint gRPC...$(NC)"
	@grpcurl -plaintext -d '{"id":"test-'$$(date +%s)'","price":100.0,"tax":10.0}' \
		localhost:$(GRPC_PORT) pb.OrderService/CreateOrder || \
		echo "$(YELLOW)âš ï¸  Instale grpcurl: make setup-tools$(NC)"

.PHONY: test-graphql
test-graphql: ## Abre o GraphQL Playground
	@echo "$(BLUE)ğŸ§ª Abrindo GraphQL Playground...$(NC)"
	@echo "$(YELLOW)Acesse: http://localhost:$(GRAPHQL_PORT)$(NC)"
	@open http://localhost:$(GRAPHQL_PORT) 2>/dev/null || \
		xdg-open http://localhost:$(GRAPHQL_PORT) 2>/dev/null || \
		echo "$(YELLOW)Abra manualmente: http://localhost:$(GRAPHQL_PORT)$(NC)"

# ==============================================================================
# Comandos de Limpeza
# ==============================================================================
.PHONY: clean
clean: ## Remove arquivos gerados
	@echo "$(BLUE)ğŸ§¹ Limpando arquivos...$(NC)"
	@rm -f $(APP_NAME) $(APP_NAME)-linux
	@rm -f coverage.out coverage.html
	@rm -rf .docker
	@echo "$(GREEN)âœ… Limpeza concluÃ­da!$(NC)"

.PHONY: clean-all
clean-all: clean docker-clean ## Remove tudo (arquivos e containers)
	@echo "$(GREEN)âœ… Limpeza completa concluÃ­da!$(NC)"

# ==============================================================================
# Comandos de InformaÃ§Ã£o
# ==============================================================================
.PHONY: info
info: ## Mostra informaÃ§Ãµes do projeto
	@echo "$(BLUE)ğŸ“Š InformaÃ§Ãµes do Projeto$(NC)"
	@echo "$(YELLOW)Nome:$(NC) $(APP_NAME)"
	@echo "$(YELLOW)VersÃ£o Go:$(NC) $(GO_VERSION)"
	@echo "$(YELLOW)Porta Web:$(NC) $(WEB_PORT)"
	@echo "$(YELLOW)Porta gRPC:$(NC) $(GRPC_PORT)"
	@echo "$(YELLOW)Porta GraphQL:$(NC) $(GRAPHQL_PORT)"
	@echo ""
	@echo "$(BLUE)ğŸ“¦ DependÃªncias:$(NC)"
	@go list -m all | head -10

.PHONY: deps
deps: ## Lista as dependÃªncias do projeto
	@echo "$(BLUE)ğŸ“¦ DependÃªncias do projeto:$(NC)"
	@go list -m all

.PHONY: deps-update
deps-update: ## Atualiza as dependÃªncias
	@echo "$(BLUE)ğŸ“¦ Atualizando dependÃªncias...$(NC)"
	@go get -u ./...
	@go mod tidy
	@echo "$(GREEN)âœ… DependÃªncias atualizadas!$(NC)"

# ==============================================================================
# Comandos Compostos
# ==============================================================================
.PHONY: start
start: docker-up db-create db-migrate run ## Inicia todo o ambiente

.PHONY: restart
restart: docker-restart run ## Reinicia todo o ambiente

.PHONY: ci
ci: fmt vet lint test ## Executa pipeline de CI

# ==============================================================================
# Ajuda
# ==============================================================================
.PHONY: help
help: ## Mostra esta ajuda
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘         Order System - Clean Architecture                 â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(YELLOW)Comandos disponÃ­veis:$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-20s$(NC) %s\n", $$1, $$2}' | \
		sort
	@echo ""
	@echo "$(BLUE)Exemplos de uso:$(NC)"
	@echo "  $(YELLOW)make setup$(NC)          - Primeira vez no projeto"
	@echo "  $(YELLOW)make start$(NC)          - Inicia tudo (DB + App)"
	@echo "  $(YELLOW)make run-dev$(NC)        - Desenvolvimento rÃ¡pido"
	@echo "  $(YELLOW)make test$(NC)           - Roda todos os testes"
	@echo "  $(YELLOW)make ci$(NC)             - Valida antes do commit"
	@echo ""

.DEFAULT_GOAL := help

